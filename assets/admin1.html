<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tasheer DMI – Admin Dashboard</title>

  <!-- Bootstrap core -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" />
  <!-- Chart.js for charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Admin-specific CSS inline -->
  <style>
    :root {
      --primary-blue: #004d9c;
      --sidebar-bg: #f8fafc;
    }

    body {
      background: #f3f4f6;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    /* Sidebar */
    .admin-sidebar {
      width: 260px;
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      overflow-y: auto;
      background: var(--sidebar-bg);
      border-right: 1px solid #e5e7eb;
      padding-top: 70px;
      z-index: 90;
    }

    .admin-sidebar-header {
      position: fixed;
      top: 0;
      left: 0;
      width: 260px;
      height: 70px;
      background: var(--sidebar-bg);
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 16px;
      z-index: 91;
    }

    .admin-sidebar .nav-link {
      padding: 10px 16px;
      border-radius: 10px;
      margin: 2px 8px;
      color: #475569;
      font-size: 0.92rem;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .admin-sidebar .nav-link i {
      font-size: 1.1rem;
    }

    .admin-sidebar .nav-link:hover {
      background: #e5f1ff;
      color: var(--primary-blue);
    }

    .admin-sidebar .nav-link.active {
      background: #e0ecff;
      color: var(--primary-blue);
      font-weight: 600;
    }

    /* Topbar */
    .admin-topbar {
      position: fixed;
      top: 0;
      left: 260px;
      right: 0;
      height: 70px;
      background: #ffffff;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      padding: 0 20px;
      z-index: 100;
    }

    /* Content */
    .admin-content {
      margin-left: 260px;
      padding: 90px 24px 32px;
      min-height: 100vh;
    }

    .kpi-card {
      border-radius: 16px;
      background: #ffffff;
      border: none;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
      padding: 18px 20px;
    }

    .kpi-label {
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #9ca3af;
      margin-bottom: 6px;
    }

    .kpi-value {
      font-size: 1.7rem;
      font-weight: 700;
      color: #111827;
    }

    .kpi-sub {
      font-size: 0.78rem;
      color: #6b7280;
    }

    .card-section {
      border-radius: 16px;
      border: none;
      background: #ffffff;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.04);
    }

    #adminAreaList .badge {
      font-size: 0.75rem;
    }
  </style>
</head>

<body onload="initAdminDashboard()">

  <!-- Sidebar brand header -->
  <div class="admin-sidebar-header">
    <div class="d-flex align-items-center gap-2">
      <div class="rounded-3 bg-primary text-white d-flex align-items-center justify-content-center"
           style="width:32px;height:32px;">
        <i class="bi bi-graph-up"></i>
      </div>
      <div>
        <div class="fw-semibold" style="font-size:0.95rem;">Tasheer DMI</div>
        <div class="text-muted" style="font-size:0.75rem;">Admin Dashboard</div>
      </div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="admin-sidebar">
    <nav id="adminDeptList" class="nav flex-column mt-2 pb-4">
      <!-- Filled by JS -->
    </nav>
  </aside>

  <!-- Topbar -->
  <header class="admin-topbar">
    <div>
      <div class="text-muted small">Department Dashboard</div>
      <h4 class="fw-semibold mb-0 text-primary" id="adminDeptTitle">Select a Department</h4>
    </div>
    <div class="ms-auto d-flex align-items-center gap-2">
      <button id="openAssessmentBtn" class="btn btn-sm btn-outline-primary" type="button">
        <i class="bi bi-box-arrow-up-right me-1"></i> Open Assessment
      </button>
      <button class="btn btn-sm btn-outline-danger" type="button" onclick="logout()">
        <i class="bi bi-power me-1"></i> Logout
      </button>
    </div>
  </header>

  <!-- Main content -->
  <main class="admin-content">
    <!-- KPI row -->
    <div class="row g-3 mb-4">
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Overall Maturity</div>
          <div id="adminOverallPercent" class="kpi-value">–</div>
          <div class="kpi-sub">Percentage of max score</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Questions Completed</div>
          <div id="adminQuestionsCard" class="kpi-value">–</div>
          <div class="kpi-sub">Answered / total</div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Maturity Band</div>
          <div id="adminBandName" class="kpi-value" style="font-size:1.3rem;">–</div>
          <div id="adminBandDesc" class="kpi-sub"></div>
        </div>
      </div>
      <div class="col-md-3 col-6">
        <div class="kpi-card">
          <div class="kpi-label">Status</div>
          <div id="adminDataStatus" class="kpi-value" style="font-size:1.3rem;">–</div>
          <div class="kpi-sub">Based on stored responses</div>
        </div>
      </div>
    </div>

    <!-- Chart + area list -->
    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card card-section p-3">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <h6 class="mb-0 fw-semibold">Area Breakdown</h6>
          </div>
          <div style="height:280px;">
            <canvas id="adminAreaChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-5">
        <div class="card card-section p-3">
          <h6 class="fw-semibold mb-2">Areas Summary</h6>
          <ul id="adminAreaList" class="list-group list-group-flush small">
            <!-- Filled by JS -->
          </ul>
        </div>
      </div>
    </div>
  </main>

  <!-- ======== EXISTING APP SCRIPTS (quizzes, logic, etc.) ======== -->
  <script src="maturitybands.js"></script>

  <!-- All department quiz files -->
  <script src="/assets/quizzes/quiz_finance.js"></script>
  <script src="/assets/quizzes/quiz_branches_ops.js"></script>
  <script src="/assets/quizzes/quiz_pmo.js"></script>
  <script src="/assets/quizzes/quiz_business_dev.js"></script>
  <script src="/assets/quizzes/quiz_product_mgmt.js"></script>
  <script src="/assets/quizzes/quiz_marketing.js"></script>
  <script src="/assets/quizzes/quiz_solution_delivery.js"></script>
  <script src="/assets/quizzes/quiz_platforms_it_ops.js"></script>
  <script src="/assets/quizzes/quiz_tech_strategy.js"></script>
  <script src="/assets/quizzes/quiz_data_analytics.js"></script>
  <script src="/assets/quizzes/quiz_corporate_IT.js"></script>
  <script src="/assets/quizzes/quiz_infra_ops.js"></script>
  <script src="/assets/quizzes/quiz_human_capital.js"></script>
  <script src="/assets/quizzes/quiz_grc.js"></script>
  <script src="/assets/quizzes/quiz_business_excellence.js"></script>
  <script src="/assets/quizzes/quiz_legal_affairs.js"></script>
  <script src="/assets/quizzes/quiz_cybersecurity.js"></script>
  <script src="/assets/quizzes/quiz_procurement.js"></script>
  <script src="/assets/quizzes/quiz_internal_audit.js"></script>

  <!-- Your shared logic + users (provides requireLogin, getColorByScore, computeDynamicAreaScores, getMaturityBand, etc.) -->
  <script src="users.js"></script>
  <script src="logic.js"></script>

  <!-- ======== ADMIN DASHBOARD JS (inline) ======== -->
  <script>
    // Global for chart & current dept
    let adminAreaChartInstance = null;
    let currentAdminDeptCode = null;

    // Master department list (code must match quiz_<code>.js and DMI_QUESTION_SETS key)
    const ADMIN_DEPARTMENTS = [

      { code: "branches_ops",       name: "Branches Operations",              icon: "bi-shop" },
      { code: "procurement",        name: "Procurement",                      icon: "bi-cart-check" },
      { code: "solution_delivery",  name: "Solution Delivery",  icon: "bi-gear" },
      { code: "internal_audit",     name: "Internal Auditing",                icon: "bi-clipboard-data" },
      { code: "data_analytics",     name: "Data Analytics",                   icon: "bi-bar-chart-line" },

      { code: "pmo",                name: "PMO",                              icon: "bi-diagram-3" },
      { code: "finance",            name: "Finance",                          icon: "bi-bank" },
      { code: "business_dev",       name: "Business Development",             icon: "bi-briefcase" },
      { code: "product_mgmt",       name: "Product Management",               icon: "bi-box-seam" },
      { code: "marketing",          name: "Mar - Comm",       icon: "bi-megaphone" },
  
      { code: "platforms_it_ops",   name: "IT Operations", icon: "bi-cpu" },
      { code: "tech_strategy",      name: "Enterprise Architecture", icon: "bi-layers" },
      { code: "corporate-IT",       name: "Corporate IT",                     icon: "bi-laptop" },
      { code: "infra_ops",          name: "Infrastructure Operations",      icon: "bi-hdd-stack" },
      { code: "human_capital",      name: "Human Capital",                              icon: "bi-people" },
      { code: "grc",                name: "GRC",                              icon: "bi-shield-check" },
      { code: "business_excellence",name: "Business Excellence",              icon: "bi-stars" },
      { code: "legal_affairs",      name: "Legal & Regulatory",               icon: "bi-journal-text" },
      { code: "cybersecurity",      name: "Cybersecurity",                    icon: "bi-shield-lock" },
    ];

    function initAdminDashboard() {
      // Use your existing login/session check
      if (typeof requireLogin === "function" && !requireLogin()) return;

      buildAdminSidebar();

      // Hook up "Open Assessment" button
      const openBtn = document.getElementById("openAssessmentBtn");
      if (openBtn) {
        openBtn.addEventListener("click", openAssessmentForCurrent);
      }
    }

    function buildAdminSidebar() {
      const list = document.getElementById("adminDeptList");
      if (!list) return;

      list.innerHTML = "";
      ADMIN_DEPARTMENTS.forEach((dept, idx) => {
        const a = document.createElement("a");
        a.href = "javascript:void(0)";
        a.className = "nav-link";
        a.dataset.code = dept.code;
        a.innerHTML = `<i class="bi ${dept.icon}"></i><span>${dept.name}</span>`;
        a.addEventListener("click", () => selectDepartment(dept.code));
        list.appendChild(a);

        if (idx === 0) {
          // auto-select first dept
          selectDepartment(dept.code);
        }
      });
    }

    function selectDepartment(deptCode) {
      currentAdminDeptCode = deptCode;

      // Highlight in sidebar
      const links = document.querySelectorAll("#adminDeptList .nav-link");
      links.forEach(link => {
        link.classList.toggle("active", link.dataset.code === deptCode);
      });

      const deptData = window.DMI_QUESTION_SETS && window.DMI_QUESTION_SETS[deptCode];
      if (!deptData) {
        updateDashboardForNoData(deptCode);
        return;
      }

      // Read saved answers from localStorage using shared function
      const key = typeof getStorageKeyFor === "function"
        ? getStorageKeyFor(deptCode)
        : "tasheer_dmi_" + deptCode;

      const saved = JSON.parse(localStorage.getItem(key) || "{}");

      let totalPoints = 0;
      let answered = 0;
      deptData.questions.forEach(q => {
        if (saved[q.id]) {
          totalPoints += Number(saved[q.id]);
          answered++;
        }
      });

      const percent = deptData.maxScore
        ? Math.round((totalPoints / deptData.maxScore) * 100)
        : 0;

      // Update text fields
      const titleEl = document.getElementById("adminDeptTitle");
      if (titleEl) titleEl.textContent = deptData.title || deptCode;

      const overallEl = document.getElementById("adminOverallPercent");
      if (overallEl) overallEl.textContent = percent + "%";

      const qEl = document.getElementById("adminQuestionsCard");
      if (qEl) qEl.textContent = answered + " / " + (deptData.totalQuestions || deptData.questions.length);

      const statusEl = document.getElementById("adminDataStatus");
      if (statusEl) {
        if (answered === 0) statusEl.textContent = "No Data";
        else if (answered < (deptData.totalQuestions || deptData.questions.length)) statusEl.textContent = "Partial";
        else statusEl.textContent = "Complete";
      }

      // Maturity band
      let band = { name: "Unclassified", description: "" };
      if (typeof getMaturityBand === "function") {
        band = getMaturityBand(percent, deptData);
      }
      const bandNameEl = document.getElementById("adminBandName");
      const bandDescEl = document.getElementById("adminBandDesc");
      if (bandNameEl) bandNameEl.textContent = band.name || "Unclassified";
      if (bandDescEl) bandDescEl.textContent = band.description || "";

      // Area breakdown using your shared computeDynamicAreaScores
      if (typeof computeDynamicAreaScores === "function") {
        const summary = computeDynamicAreaScores(deptData, saved);
        renderAdminAreaChart(summary);
        renderAdminAreaList(summary);
      }
    }

    function updateDashboardForNoData(deptCode) {
      const deptMeta = ADMIN_DEPARTMENTS.find(d => d.code === deptCode);

      const titleEl = document.getElementById("adminDeptTitle");
      if (titleEl) titleEl.textContent = (deptMeta && deptMeta.name) || deptCode;

      ["adminOverallPercent", "adminQuestionsCard"].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = "–";
      });

      const statusEl = document.getElementById("adminDataStatus");
      if (statusEl) statusEl.textContent = "No Data";

      const bandNameEl = document.getElementById("adminBandName");
      if (bandNameEl) bandNameEl.textContent = "Unclassified";
      const bandDescEl = document.getElementById("adminBandDesc");
      if (bandDescEl) bandDescEl.textContent = "";

      renderAdminAreaChart({ areas: [], overall: 0 });
      renderAdminAreaList({ areas: [], overall: 0 });
    }

    function renderAdminAreaChart(summary) {
      const ctx = document.getElementById("adminAreaChart");
      if (!ctx) return;

      const labels = summary.areas.map(a => a.area);
      const data = summary.areas.map(a => a.percent);
      const colors = data.map(p => typeof getColorByScore === "function"
        ? getColorByScore(p)
        : "rgba(0,77,156,1)");

      if (adminAreaChartInstance) adminAreaChartInstance.destroy();

      adminAreaChartInstance = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [{
            label: "Maturity %",
            data,
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              min: 0, max: 100,
              ticks: { stepSize: 10 }
            },
            x: { grid: { display: false } }
          }
        }
      });
    }

    function renderAdminAreaList(summary) {
      const list = document.getElementById("adminAreaList");
      if (!list) return;

      list.innerHTML = "";

      summary.areas.forEach(a => {
        const li = document.createElement("li");
        li.className = "list-group-item d-flex justify-content-between align-items-center";
        li.innerHTML = `
          <span>${a.area}</span>
          <span class="badge bg-light text-dark">${a.percent}%</span>
        `;
        list.appendChild(li);
      });

      const overallLi = document.createElement("li");
      overallLi.className = "list-group-item d-flex justify-content-between align-items-center fw-semibold";
      overallLi.innerHTML = `
        <span>Overall</span>
        <span class="badge bg-primary text-white">${summary.overall || 0}%</span>
      `;
      list.appendChild(overallLi);
    }

    // Open assessment in a NEW TAB for currently selected department
    function openAssessmentForCurrent() {
      if (!currentAdminDeptCode) return;

      const deptCode = currentAdminDeptCode;
      const deptData = window.DMI_QUESTION_SETS && window.DMI_QUESTION_SETS[deptCode];

      // Seed sessionStorage so index.html thinks we are that department
      sessionStorage.setItem("dmi_logged_in", "true");
      sessionStorage.setItem("dmi_role", "department");
      sessionStorage.setItem("dmi_deptCode", deptCode);
      sessionStorage.setItem(
        "dmi_displayName",
        (deptData && deptData.title) || deptCode.toUpperCase()
      );

      window.open("index.html", "_blank");
    }
  </script>
</body>
</html>
